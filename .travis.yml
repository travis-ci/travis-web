---
language: node_js
node_js: 8.5

env:
  global:
    - PERCY_ENABLE=0

sudo: required
dist: trusty

addons:
  chrome: stable

cache:
  directories:
    - node_modules
    - bower_components

env:
  global:
    # See https://git.io/vdao3 for details.
    - JOBS=1

before_install:
  - npm config set spin false
  - npm install -g npm@5
  - npm install -g bower
  - bower --version
  - npm --version
  - npm install -g greenkeeper-lockfile@1

install:
  - npm install
  - bower install

before_script:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start
  - "/sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -ac -screen 0 1920x1080x16"
  - sleep 3 # give xvfb some time to start
  - if [ $TRAVIS_PULL_REQUEST = 'false' ]; then echo "Enabling Percy on push with default Ember" && export PERCY_ENABLE=1; else export PERCY_ENABLE=0; fi
  - echo $PERCY_ENABLE
  - if [ "$PERCY_ENABLE" -ne 1 ]; then export RANDOMISE=--random; fi
  - echo $RANDOMISE
  - greenkeeper-lockfile-update

script:
  - npm run lint:js
  - ember exam --reporter dot $RANDOMISE

after_script:
  - greenkeeper-lockfile-upload

before_deploy:
  - ASSETS_HOST=https://s3.amazonaws.com/travis-error-pages ember build --env production
  # delete some of the stuff that's useless for maintenance page
  - rm -fr dist/assets/*.js dist/images/emoji dist/index.html dist/images/sponsors
  - cp dist/maintenance.html dist/index.html

deploy:
  - provider: s3
    access_key_id: $MAINTENANCE_S3_ACCESS_KEY_ID
    secret_access_key: $MAINTENANCE_S3_SECRET_ACCESS_KEY
    bucket: travis-error-pages
    skip_cleanup: true
    acl: public_read
    local_dir: dist
    region: us-east-1
    on:
      branch: master

after_success:
  - "test $TRAVIS_PULL_REQUEST && test $TRAVIS_PULL_REQUEST != 'false' && $TRAVIS_SECURE_ENV_VARS == 'true' && ./config/deployment/deploy-pull-request.sh"
